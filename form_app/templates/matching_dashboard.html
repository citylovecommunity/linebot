{% extends "base.html" %}

{% block content %}


<div class="container py-5">

    <div class="row mb-5">
        <div class="col-12">
            <div class="modern-card p-4">
                <div class="step-indicator d-flex justify-content-between text-center">
                    <div class="step-item {{ 'step-completed' if status_step > 1 else 'step-active' }}">
                        <div class="step-dot"><i class="bi bi-people-fill"></i></div>
                        <small class="fw-bold">é…å°ä¸­</small>
                    </div>
                    <div
                        class="step-item {{ 'step-completed' if status_step > 2 else ('step-active' if status_step == 2 else '') }}">
                        <div class="step-dot"><i class="bi bi-calendar-range"></i></div>
                        <small class="fw-bold">ç´„æœƒè¦åŠƒä¸­</small>
                    </div>
                    <div class="step-item {{ 'step-completed' if status_step == 3 }}">
                        <div class="step-dot"><i class="bi bi-check-lg"></i></div>
                        <small class="fw-bold">é…å°å®Œæˆ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">

            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-body p-4 text-center">
                    <div class="mb-3">
                        <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3 py-1 fw-normal">
                            <i class="bi bi-stars me-1"></i> ä½ çš„é…å°
                        </span>
                    </div>

                    <div class="mx-auto mb-3 bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                        style="width: 64px; height: 64px; font-size: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        {{ partner.name[0] | upper }}
                    </div>

                    <h5 class="fw-bold mb-1">{{ partner.get_proper_name() }}</h5>
                    <p class="text-muted small mb-3">Matched on {{ matching.created_at.strftime('%b %d') }}</p>

                    <a href="{{ partner.get_introduction_link() }}" target="_blank"
                        class="text-decoration-none text-primary fw-bold small hover-lift">
                        é–‹å•Ÿä»‹ç´¹å¡ <i class="bi bi-box-arrow-up-right ms-1 small"></i>
                    </a>
                </div>
            </div>

            <div class="modern-card h-100 {{ 'border-success' if status_step == 3 }}">
                <div class="card-header-clean d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-calendar-event me-2 text-primary"></i> ç´„æœƒ</span>
                    {% if status_step == 3 %}
                    <span class="badge bg-success">Confirmed!</span>
                    {% endif %}
                </div>

                <div class="card-body">
                    {% if status_step == 1 and not is_proposal_pending %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-cup-hot fs-1 mb-2 d-block opacity-50"></i>
                        <p>å°šæœªå®‰æ’ç´„æœƒ</p>
                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#proposalModal">
                            æè­°ç´„æœƒï¼
                        </button>
                    </div>

                    {% elif is_proposal_pending %}
                    <div class="alert {{ 'alert-info' if proposed_by_me else 'alert-warning' }}">
                        <h6 class="alert-heading fw-bold">
                            {% if proposed_by_me %} æ‚¨å·²æå‡ºç´„æœƒ {% else %} æ–°çš„ç´„æœƒæè­°ï¼ {% endif %}
                        </h6>
                        <hr>
                        <p class="mb-1"><strong><i class="bi bi-shop"></i> åœ°é»:</strong> {{ proposal.restaurant_name
                            }}</p>
                        <p class="mb-1"><strong><i class="bi bi-clock"></i> æ™‚é–“:</strong> {{ proposal.proposed_datetime
                            }}</p>
                        <p class="mb-0 small text-muted">
                            <em>è¨‚ä½è³‡è¨Š: {{ "æˆ‘éœ€è¦è¨‚ä½" if proposal.booker_role == 'me' and proposal.proposer_id == user_id
                                else "æˆ‘ç„¡éœ€è¨‚ä½" }}</em>
                        </p>
                    </div>

                    {% if not proposed_by_me %}
                    <form
                        action="{{ url_for('dashboard_bp.handle_proposal', matching_id=matching.id, user_id=user_id) }}"
                        method="POST" class="d-grid gap-2">
                        <button name="action" value="accept" class="btn btn-success">
                            <i class="bi bi-check-lg me-2"></i>æ¥å—ç´„æœƒ
                        </button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal"
                            data-bs-target="#proposalModal">
                            <i class="bi bi-pencil me-2"></i>æ›´æ”¹ææ¡ˆ
                        </button>
                    </form>
                    {% else %}
                    <div class="text-center text-muted small">
                        ç­‰å¾… {{ partner.get_proper_name() }} å›è¦†...
                    </div>
                    {% endif %}

                    {% elif status_step == 3 %}
                    <div class="text-center mb-3">
                        <h2 class="text-success fw-bold">{{ matching.selected_date.strftime('%d') }}</h2>
                        <h5 class="text-uppercase text-muted">{{ matching.selected_date.strftime('%B') }}</h5>
                        <div class="badge bg-light text-dark border p-2 mt-2">
                            {{ matching.selected_date.strftime('%H:%M') }}
                        </div>
                    </div>
                    <div class="border-top pt-3">
                        <p class="mb-1"><strong>åœ°é»:</strong> {{ matching.selected_place }}</p>
                        <p class="small text-muted mb-3">
                            {% if matching.booker_id == current_user.id %}
                            <span class="text-danger"><i class="bi bi-exclamation-circle"></i> åˆ¥å¿˜è¨˜è¨‚ä½</span>
                            {% else %}
                            <span class="text-success"><i class="bi bi-info-circle"></i> å°æ–¹æœƒè™•ç†è¨‚ä½</span>
                            {% endif %}
                        </p>

                        <form
                            action="{{ url_for('dashboard_bp.handle_proposal', matching_id=matching.id, user_id=user_id) }}"
                            method="POST">
                            <button class="btn btn-outline-danger btn-sm w-100" value="reject" name="action">
                                å–æ¶ˆç´„æœƒ
                            </button>
                        </form>

                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="modern-card h-100">
                <div class="card-header-clean d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-chat-dots me-2 text-primary"></i> ç´„æœƒ</span>
                    <span class="badge bg-light text-dark">{{ messages|length }} messages</span>
                </div>

                <div class="chat-container" id="messageBox">
                    {% for msg in messages %}
                    {% set is_me = (msg.user.id == current_user.id) %}
                    {% if msg.is_system_notification %}
                    <div class="text-center my-3">
                        <span class="badge bg-light text-muted fw-normal border px-3 py-2">{{ msg.content }}</span>
                    </div>
                    {% else %}
                    <div class="chat-bubble {{ 'msg-outgoing' if is_me else 'msg-incoming' }}">
                        {% if not is_me %}
                        <div class="fw-bold small mb-1">{{ msg.user.get_proper_name() }}</div>
                        {% endif %}
                        {{ msg.content }}
                        <span class="msg-time">{{ msg.timestamp.strftime('%H:%M') }}</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                <div class="p-3 border-top bg-white">
                    <form method="POST">
                        <div class=" input-group">
                            <input type="text" name="message_content" class="form-control border-0 bg-light"
                                placeholder="Type a message..." style="padding: 12px;" required>
                            <button class="btn btn-primary px-4"><i class="bi bi-send-fill"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="proposalModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç´„æœƒæ’ç¨‹ ğŸŒ¹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form
                action="{{ url_for('dashboard_bp.submit_proposal', matching_id=matching.id, user_id=current_user.id) }}"
                method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">é¤å»³/åœ°é»</label>
                        <input type="text" name="restaurant" class="form-control" placeholder="ä¾‹ï¼š åŒ—è»Šé¥—é£Ÿå¤©å ‚" required
                            value="{{ proposal.restaurant if proposal else '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ—¥æœŸ/æ™‚é–“</label>
                        <input type="datetime-local" name="date_time" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">èª°è¨‚ä½</label>
                        <select name="booker" class="form-select">
                            <option value="me">æˆ‘ä¾†è¨‚ä½</option>
                            <option value="partner">éº»ç…©å°æ–¹è¨‚ä½</option>
                            <option value="none">ä¸ç”¨è¨‚ä½ï¼Œç›´æ¥å»</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æå‡ºç´„æœƒ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    var messageBox = document.getElementById("messageBox");
    messageBox.scrollTop = messageBox.scrollHeight;
</script>

{% endblock %}