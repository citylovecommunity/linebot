{% set zh_months = {
1: 'ä¸€æœˆ', 2: 'äºŒæœˆ', 3: 'ä¸‰æœˆ', 4: 'å››æœˆ',
5: 'äº”æœˆ', 6: 'å…­æœˆ', 7: 'ä¸ƒæœˆ', 8: 'å…«æœˆ',
9: 'ä¹æœˆ', 10: 'åæœˆ', 11: 'åä¸€æœˆ', 12: 'åäºŒæœˆ'
} %}



{% extends "base.html" %}

{% block content %}

<div class="container py-5">

    <div class="row mb-5">
        <div class="col-12">
            <div class="modern-card p-4">
                <div class="step-indicator d-flex justify-content-between text-center">
                    <div class="step-item {{ 'step-completed' if status_step > 1 else 'step-active' }}">
                        <div class="step-dot"><i class="bi bi-people-fill"></i></div>
                        <small class="fw-bold">é…å°ä¸­</small>
                    </div>
                    <div
                        class="step-item {{ 'step-completed' if status_step > 2 else ('step-active' if status_step == 2 else '') }}">
                        <div class="step-dot"><i class="bi bi-calendar-range"></i></div>
                        <small class="fw-bold">ä»»å‹™è¦åŠƒä¸­</small>
                    </div>
                    <div class="step-item {{ 'step-completed' if status_step == 3 }}">
                        <div class="step-dot"><i class="bi bi-check-lg"></i></div>
                        <small class="fw-bold">é…å°å®Œæˆ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4 d-flex flex-column">

            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-body p-4 text-center">
                    <div class="mb-3">
                        <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3 py-1 fw-normal">
                            <i class="bi bi-stars me-1"></i> ä½ çš„é…å°
                        </span>
                        {% if matching.status == 'cancelled' %}
                        <span class="badge bg-danger rounded-pill px-3 py-1 fw-normal ms-1">
                            Cancelled
                        </span>
                        {% endif %}
                    </div>

                    <div class="mx-auto mb-3 bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                        style="width: 64px; height: 64px; font-size: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        {{ partner.name[0] | upper }}
                    </div>

                    <h5 class="fw-bold mb-1">{{ partner.get_proper_name() }}</h5>

                    <div class="location-tag small text-muted mb-2">
                        <i class="bi bi-hash text-warning opacity-75 fw-bold"></i>
                        {{ matching.cool_name }}
                    </div>

                    <p class="text-muted small mb-3">Matched on {{ matching.created_at.strftime('%b %d') }}</p>

                    <a href="{{ partner.get_introduction_link() }}" target="_blank"
                        class="text-decoration-none text-primary fw-bold small hover-lift mb-3 d-block">
                        é–‹å•Ÿä»‹ç´¹å¡ <i class="bi bi-box-arrow-up-right ms-1 small"></i>
                    </a>

                    <div class="border-top pt-3 mt-2">
                        {% if matching.is_cancelled and matching.cancel_by_id == current_user.id%}
                        <form action="{{ url_for('dashboard_bp.update_match_status', matching_id=matching.id) }}"
                            method="POST">
                            <button type="submit" name="action" value="active"
                                class="btn btn-outline-success btn-sm w-100">
                                <i class="bi bi-arrow-counterclockwise me-1"></i> æ¢å¾©é…å° (Revert)
                            </button>
                        </form>
                        {% elif not matching.is_cancelled %}
                        <form action="{{ url_for('dashboard_bp.update_match_status', matching_id=matching.id) }}"
                            method="POST">
                            <button type="submit" name="action" value="cancelled"
                                class="btn btn-light text-muted btn-sm w-100"
                                onclick="return confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤é…å°å—ï¼Ÿå–æ¶ˆå¾Œå°‡ç„¡æ³•å‚³é€è¨Šæ¯ã€‚');">
                                <i class="bi bi-slash-circle me-1"></i> å–æ¶ˆé…å° (Cancel)
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if not matching.is_cancelled %}
            <div class="modern-card flex-grow-1 {{ 'border-success' if status_step == 3 }}">
                <div class="card-header-clean d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-calendar-event me-2 text-primary"></i> ä»»å‹™</span>
                    {% if status_step == 3 %}
                    <span class="badge bg-success">Confirmed!</span>
                    {% endif %}
                </div>

                <div class="card-body">
                    {% if status_step == 1 %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-rocket-takeoff-fill fs-1 mb-2 d-block opacity-50"></i>
                        <p>å°šæœªå®‰æ’ä»»å‹™</p>
                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#proposalModal">
                            æè­°ä»»å‹™ï¼
                        </button>
                    </div>

                    {% elif status_step == 2 %}
                    <div class="alert {{ 'alert-info' if proposed_by_me else 'alert-warning' }}">
                        <h6 class="alert-heading fw-bold">
                            {% if proposal.proposer_id == current_user.id %} æ‚¨å·²æå‡ºä»»å‹™ {% else %} æ–°çš„ä»»å‹™æè­°ï¼ {% endif %}
                        </h6>
                        <hr>
                        <p class="mb-1"><strong><i class="bi bi-shop"></i> åœ°é»:</strong> {{ proposal.restaurant_name
                            }}</p>
                        <p class="mb-1"><strong><i class="bi bi-clock"></i> æ™‚é–“:</strong> {{ proposal.proposed_datetime
                            }}</p>
                        <p class="mb-0 small text-muted">
                            <em>è¨‚ä½è³‡è¨Š:
                                {% if proposal.who_reservation is none %}
                                ç„¡éœ€è¨‚ä½
                                {% elif proposal.who_reservation == current_user.id %}
                                æˆ‘éœ€è¦è¨‚ä½
                                {% else %}
                                å°æ–¹è™•ç†è¨‚ä½
                                {% endif %}
                            </em>
                        </p>
                    </div>

                    {% if proposal.proposer_id != current_user.id %}
                    <form
                        action="{{ url_for('dashboard_bp.handle_proposal', matching_id=matching.id, proposal_id=proposal.id) }}"
                        method="POST" class="d-grid gap-2">
                        <button name="action" value="accept" class="btn btn-success">
                            <i class="bi bi-check-lg me-2"></i>æ¥å—æè­°
                        </button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal"
                            data-bs-target="#proposalModal">
                            <i class="bi bi-pencil me-2"></i>æ›´æ”¹ææ¡ˆ
                        </button>
                    </form>
                    {% else %}
                    <div class="text-center text-muted small mb-3">
                        ç­‰å¾… {{ partner.get_proper_name() }} å›è¦†...
                    </div>
                    <form
                        action="{{ url_for('dashboard_bp.handle_proposal', matching_id=matching.id, proposal_id=proposal.id) }}"
                        method="POST">
                        <button class="btn btn-outline-danger btn-sm w-100" value="reject" name="action"
                            onclick="return confirm('ç¢ºå®šè¦æ›´æ”¹æè­°å—ï¼Ÿé€™é …æ“ä½œç„¡æ³•å¾©åŸã€‚');">
                            æ›´æ”¹ä»»å‹™æè­°
                        </button>
                    </form>
                    {% endif %}

                    {% elif status_step == 3 %}
                    <div class="text-center mb-3">
                        <h2 class="text-success fw-bold">{{ proposal.proposed_datetime.strftime('%d') }}</h2>
                        <h5 class="text-uppercase text-muted">
                            {{ zh_months[proposal.proposed_datetime.month] }}
                        </h5>
                        <div class="badge bg-light text-dark border p-2 mt-2">
                            {{ proposal.proposed_datetime.strftime('%H:%M') }}
                        </div>
                    </div>
                    <div class="border-top pt-3">
                        <p class="mb-1"><strong>åœ°é»:</strong> {{ proposal.restaurant_name }}</p>
                        <p class="small text-muted mb-3">
                            {# CASE 1: No one needs to reserve #}
                            {% if proposal.who_reservation is none %}
                            <span class="text-secondary">
                                <i class="bi bi-dash-circle"></i> ç„¡éœ€è¨‚ä½
                            </span>

                            {# CASE 2: I am the one responsible (ID matches me) #}
                            {% elif proposal.who_reservation == current_user.id %}
                            <span class="text-danger fw-bold">
                                <i class="bi bi-exclamation-circle-fill"></i> è«‹è¨˜å¾—è¨‚ä½ (æ‚¨è² è²¬)
                            </span>

                            {# CASE 3: The other person is responsible #}
                            {% else %}
                            <span class="text-success">
                                <i class="bi bi-check-circle-fill"></i> å°æ–¹æœƒè™•ç†è¨‚ä½
                            </span>
                            {% endif %}
                        </p>

                        <form
                            action="{{ url_for('dashboard_bp.handle_proposal', matching_id=matching.id, proposal_id=proposal.id) }}"
                            method="POST">
                            <button class="btn btn-outline-danger btn-sm w-100" value="reject" name="action"
                                onclick="return confirm('ç¢ºå®šè¦æ›´æ”¹æè­°å—ï¼Ÿé€™é …æ“ä½œç„¡æ³•å¾©åŸã€‚');">
                                æ›´æ”¹ä»»å‹™æè­°
                            </button>
                        </form>

                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div
                class="modern-card flex-grow-1 border-0 bg-light d-flex align-items-center justify-content-center text-muted">
                <div class="text-center p-4">
                    <i class="bi bi-slash-circle fs-1 mb-2"></i>
                    <p class="mb-0">é…å°å·²å–æ¶ˆï¼Œç„¡æ³•å®‰æ’ä»»å‹™ã€‚</p>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-8">
            <div class="modern-card h-100">
                <div class="card-header-clean d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-chat-dots me-2 text-primary"></i> å°è©±</span>
                    <span class="badge bg-light text-dark">{{ messages|length }} messages</span>
                </div>

                <div class="chat-container" id="messageBox">
                    {% for msg in messages %}
                    {% set is_me = (msg.user.id == current_user.id) %}
                    {% if msg.is_system_notification %}
                    <div class="text-center my-3">
                        <span class="badge bg-light text-muted fw-normal border px-3 py-2">{{ msg.content }}</span>
                    </div>
                    {% else %}
                    <div class="chat-bubble {{ 'msg-outgoing' if is_me else 'msg-incoming' }}">
                        {% if not is_me %}
                        <div class="fw-bold small mb-1">{{ msg.user.get_proper_name() }}</div>
                        {% endif %}
                        {{ msg.content }}
                        <span class="msg-time">{{ msg.timestamp.strftime('%H:%M') }}</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                <div class="p-3 border-top bg-white">
                    {% if matching.is_cancelled %}
                    <div class="alert alert-secondary mb-0 text-center py-2">
                        <i class="bi bi-lock-fill me-2"></i>
                        é…å°å·²å–æ¶ˆï¼Œå°è©±åŠŸèƒ½æš«æ™‚é—œé–‰ã€‚
                    </div>
                    {% else %}
                    <form method="POST"
                        action="{{ url_for('dashboard_bp.submit_message', matching_id = matching.id) }}">
                        <div class=" input-group">
                            <input type="text" name="message_content" class="form-control border-0 bg-light"
                                placeholder="Type a message..." style="padding: 12px;" required>
                            <button class="btn btn-primary px-4"><i class="bi bi-send-fill"></i></button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="proposalModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ä»»å‹™æ’ç¨‹ ğŸ•µï¸â€â™‚ï¸</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('dashboard_bp.submit_proposal', matching_id=matching.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">é¤å»³/åœ°é»</label>
                        <input type="text" name="restaurant" class="form-control" placeholder="ä¾‹ï¼š åŒ—è»Šé¥—é£Ÿå¤©å ‚" required
                            value="{{ proposal.restaurant if proposal else '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ—¥æœŸ/æ™‚é–“</label>
                        <input type="datetime-local" name="date_time" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">èª°è¨‚ä½</label>
                        <select name="booker" class="form-select">
                            <option value="me">æˆ‘ä¾†è¨‚ä½</option>
                            <option value="partner">éº»ç…©å°æ–¹è¨‚ä½</option>
                            <option value="none">ä¸ç”¨è¨‚ä½ï¼Œç›´æ¥å»</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æå‡ºä»»å‹™</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    var messageBox = document.getElementById("messageBox");
    messageBox.scrollTop = messageBox.scrollHeight;
</script>

{% endblock %}